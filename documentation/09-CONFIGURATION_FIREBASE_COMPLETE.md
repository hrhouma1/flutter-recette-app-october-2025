# Documentation Technique - Configuration Firebase Complète

## Informations du document

**Date de création :** 27 octobre 2025  
**Projet :** flutter-recette-october-2025-1  
**Version :** 1.0  
**Auteur :** Documentation technique du projet

---

## Table des matières

1. [Vue d'ensemble de la configuration](#vue-densemble-de-la-configuration)
2. [Fichier firebase_options.dart](#fichier-firebase_optionsdart)
3. [Configuration Android](#configuration-android)
4. [Configuration iOS](#configuration-ios)
5. [Configuration Web](#configuration-web)
6. [Configuration Windows](#configuration-windows)
7. [Fichiers de configuration Firebase CLI](#fichiers-de-configuration-firebase-cli)
8. [Migration entre projets](#migration-entre-projets)

---

## Vue d'ensemble de la configuration

### Projets Firebase utilisés

#### Projet initial
- **Nom :** flutter-recette-october-2025
- **Status :** Remplacé
- **Raison :** Problèmes de permissions et configuration

#### Projet actuel
- **Nom :** flutter-recette-october-2025-1
- **ID Projet :** flutter-recette-october-2025-1
- **Région Firestore :** europe-west3
- **Mode :** Test (développement)

### Services Firebase activés

1. **Firebase Core**
   - Initialisation de base
   - Configuration multi-plateforme

2. **Cloud Firestore**
   - Base de données NoSQL
   - Collection : categories
   - Mode : Test

3. **Firebase CLI**
   - Déploiement des règles
   - Gestion du projet

### Fichiers de configuration générés

```
projetrecette/
├── .firebaserc                           # Configuration CLI
├── firebase.json                         # Configuration services
├── firestore.rules                       # Règles de sécurité
├── firestore.indexes.json                # Index Firestore
├── lib/
│   └── firebase_options.dart             # Options multi-plateforme
├── android/
│   └── app/
│       └── google-services.json          # Config Android
└── ios/
    └── Runner/
        └── GoogleService-Info.plist      # Config iOS
```

---

## Fichier firebase_options.dart

### Emplacement

`lib/firebase_options.dart`

### Génération

**Commande FlutterFire CLI :**
```bash
flutterfire configure
```

**Processus :**
1. Connexion au compte Google
2. Sélection ou création du projet
3. Sélection des plateformes
4. Génération du fichier dart
5. Mise à jour des configurations natives

### Structure complète

```dart
// File generated by FlutterFire CLI.
// ignore_for_file: type=lint
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

/// Default [FirebaseOptions] for use with your Firebase apps.
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyBmYg5-3PoffTGqShhVKrTsylxnHz1-XNs',
    appId: '1:378029160591:web:59be5d6b6a08a141db98fa',
    messagingSenderId: '378029160591',
    projectId: 'flutter-recette-october-2025',
    authDomain: 'flutter-recette-october-2025.firebaseapp.com',
    storageBucket: 'flutter-recette-october-2025.firebasestorage.app',
    measurementId: 'G-GRN6DHBLTY',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyBLZSO1AggFvbbV-OSTw_BQw8QVkRJvZPc',
    appId: '1:378029160591:android:51e654757104ef02db98fa',
    messagingSenderId: '378029160591',
    projectId: 'flutter-recette-october-2025',
    storageBucket: 'flutter-recette-october-2025.firebasestorage.app',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyCG7e4WHWPEeEeTOMWQ46N4IMyglPebm4c',
    appId: '1:378029160591:ios:d4b3d96853cc3c9ddb98fa',
    messagingSenderId: '378029160591',
    projectId: 'flutter-recette-october-2025',
    storageBucket: 'flutter-recette-october-2025.firebasestorage.app',
    iosBundleId: 'com.example.projetrecette',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyCG7e4WHWPEeEeTOMWQ46N4IMyglPebm4c',
    appId: '1:378029160591:ios:d4b3d96853cc3c9ddb98fa',
    messagingSenderId: '378029160591',
    projectId: 'flutter-recette-october-2025',
    storageBucket: 'flutter-recette-october-2025.firebasestorage.app',
    iosBundleId: 'com.example.projetrecette',
  );

  static const FirebaseOptions windows = FirebaseOptions(
    apiKey: 'AIzaSyBmYg5-3PoffTGqShhVKrTsylxnHz1-XNs',
    appId: '1:378029160591:web:406dd113a3e042d0db98fa',
    messagingSenderId: '378029160591',
    projectId: 'flutter-recette-october-2025',
    authDomain: 'flutter-recette-october-2025.firebaseapp.com',
    storageBucket: 'flutter-recette-october-2025.firebasestorage.app',
    measurementId: 'G-MSR6PKZHM2',
  );
}
```

### Détails des options

#### Options Web

| Paramètre | Valeur | Description |
|-----------|--------|-------------|
| apiKey | AIzaSyBmYg5-3PoffTGqShhVKrTsylxnHz1-XNs | Clé API publique pour Web |
| appId | 1:378029160591:web:59be5d6b6a08a141db98fa | Identifiant unique de l'app Web |
| messagingSenderId | 378029160591 | ID pour Firebase Cloud Messaging |
| projectId | flutter-recette-october-2025 | ID du projet Firebase |
| authDomain | flutter-recette-october-2025.firebaseapp.com | Domaine d'authentification |
| storageBucket | flutter-recette-october-2025.firebasestorage.app | Bucket Cloud Storage |
| measurementId | G-GRN6DHBLTY | Google Analytics |

#### Options Android

| Paramètre | Valeur | Description |
|-----------|--------|-------------|
| apiKey | AIzaSyBLZSO1AggFvbbV-OSTw_BQw8QVkRJvZPc | Clé API pour Android |
| appId | 1:378029160591:android:51e654757104ef02db98fa | Identifiant de l'app Android |
| messagingSenderId | 378029160591 | FCM Sender ID |
| projectId | flutter-recette-october-2025 | ID du projet |
| storageBucket | flutter-recette-october-2025.firebasestorage.app | Storage bucket |

**Paramètres manquants :**
- `authDomain` : Non utilisé sur Android (natif)
- `measurementId` : Non requis pour Android

#### Options iOS/macOS

Identiques pour iOS et macOS (apps Apple partagent la config).

| Paramètre | Valeur | Description |
|-----------|--------|-------------|
| apiKey | AIzaSyCG7e4WHWPEeEeTOMWQ46N4IMyglPebm4c | Clé API pour iOS |
| appId | 1:378029160591:ios:d4b3d96853cc3c9ddb98fa | Identifiant de l'app iOS |
| messagingSenderId | 378029160591 | APNs via FCM |
| projectId | flutter-recette-october-2025 | ID du projet |
| storageBucket | flutter-recette-october-2025.firebasestorage.app | Storage bucket |
| iosBundleId | com.example.projetrecette | Bundle ID iOS |

#### Options Windows

Utilise la même configuration que Web :
- Mêmes API keys
- Même appId (différent de Web)
- Même domaines

### Utilisation dans le code

**Fichier :** `lib/main.dart`

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  runApp(const MyApp());
}
```

**Sélection automatique :**
- Sur Web : Utilise `DefaultFirebaseOptions.web`
- Sur Android : Utilise `DefaultFirebaseOptions.android`
- Sur iOS : Utilise `DefaultFirebaseOptions.ios`
- Etc.

---

## Configuration Android

### Fichier google-services.json

#### Emplacement

`android/app/google-services.json`

#### Structure

```json
{
  "project_info": {
    "project_number": "378029160591",
    "project_id": "flutter-recette-october-2025",
    "storage_bucket": "flutter-recette-october-2025.firebasestorage.app"
  },
  "client": [
    {
      "client_info": {
        "mobilesdk_app_id": "1:378029160591:android:51e654757104ef02db98fa",
        "android_client_info": {
          "package_name": "com.example.projetrecette"
        }
      },
      "oauth_client": [],
      "api_key": [
        {
          "current_key": "AIzaSyBLZSO1AggFvbbV-OSTw_BQw8QVkRJvZPc"
        }
      ],
      "services": {
        "appinvite_service": {
          "other_platform_oauth_client": []
        }
      }
    }
  ],
  "configuration_version": "1"
}
```

#### Éléments clés

**project_info :**
- Informations globales du projet
- Partagées par toutes les apps Android du projet

**client :**
- Liste des applications Android
- Peut contenir plusieurs apps (différents package names)

**package_name :**
- Doit correspondre à `applicationId` dans `build.gradle`
- Format : Reverse domain (com.example.app)

### Configuration Gradle

#### Fichier : android/app/build.gradle.kts

**Modifications requises :**

```kotlin
plugins {
    id("com.android.application")
    id("kotlin-android")
    id("dev.flutter.flutter-gradle-plugin")
    id("com.google.gms.google-services")  // Ajouté
}

android {
    namespace = "com.example.projetrecette"
    compileSdk = 34
    
    defaultConfig {
        applicationId = "com.example.projetrecette"
        minSdk = 21
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"
    }
}

dependencies {
    implementation(platform("com.google.firebase:firebase-bom:32.3.1"))
    implementation("com.google.firebase:firebase-analytics")
}
```

#### Fichier : android/build.gradle.kts

**Ajout du classpath :**

```kotlin
buildscript {
    dependencies {
        classpath("com.google.gms:google-services:4.4.0")
    }
}
```

#### Fichier : android/settings.gradle.kts

**Configuration des repositories :**

```kotlin
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id("dev.flutter.flutter-plugin-loader") version "1.0.0"
    id("com.android.application") version "8.1.0" apply false
    id("org.jetbrains.kotlin.android") version "1.8.0" apply false
}
```

---

## Configuration iOS

### Fichier GoogleService-Info.plist

#### Emplacement

`ios/Runner/GoogleService-Info.plist`

#### Format XML

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>API_KEY</key>
	<string>AIzaSyCG7e4WHWPEeEeTOMWQ46N4IMyglPebm4c</string>
	<key>GCM_SENDER_ID</key>
	<string>378029160591</string>
	<key>PLIST_VERSION</key>
	<string>1</string>
	<key>BUNDLE_ID</key>
	<string>com.example.projetrecette</string>
	<key>PROJECT_ID</key>
	<string>flutter-recette-october-2025</string>
	<key>STORAGE_BUCKET</key>
	<string>flutter-recette-october-2025.firebasestorage.app</string>
	<key>IS_ADS_ENABLED</key>
	<false></false>
	<key>IS_ANALYTICS_ENABLED</key>
	<false></false>
	<key>IS_APPINVITE_ENABLED</key>
	<true></true>
	<key>IS_GCM_ENABLED</key>
	<true></true>
	<key>IS_SIGNIN_ENABLED</key>
	<true></true>
	<key>GOOGLE_APP_ID</key>
	<string>1:378029160591:ios:d4b3d96853cc3c9ddb98fa</string>
</dict>
</plist>
```

#### Clés importantes

| Clé | Description |
|-----|-------------|
| API_KEY | Clé API iOS |
| PROJECT_ID | ID du projet Firebase |
| BUNDLE_ID | Bundle identifier iOS |
| GOOGLE_APP_ID | ID unique de l'app iOS |
| STORAGE_BUCKET | Bucket Cloud Storage |
| GCM_SENDER_ID | Google Cloud Messaging |

### Configuration Xcode

#### Info.plist

Aucune modification requise si généré par FlutterFire.

#### Podfile

**Emplacement :** `ios/Podfile`

**Contenu minimal :**
```ruby
platform :ios, '12.0'

target 'Runner' do
  use_frameworks!
  use_modular_headers!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
end
```

**Installation des pods :**
```bash
cd ios
pod install
cd ..
```

---

## Configuration Web

### Initialisation

Flutter Web utilise la configuration depuis `firebase_options.dart`.

### Options Web détaillées

```dart
static const FirebaseOptions web = FirebaseOptions(
  apiKey: 'AIzaSyBmYg5-3PoffTGqShhVKrTsylxnHz1-XNs',
  appId: '1:378029160591:web:59be5d6b6a08a141db98fa',
  messagingSenderId: '378029160591',
  projectId: 'flutter-recette-october-2025',
  authDomain: 'flutter-recette-october-2025.firebaseapp.com',
  storageBucket: 'flutter-recette-october-2025.firebasestorage.app',
  measurementId: 'G-GRN6DHBLTY',
);
```

### Fichier index.html

#### Emplacement

`web/index.html`

#### Configuration (pas de modification requise)

FlutterFire gère automatiquement l'initialisation. Aucun script Firebase n'est ajouté manuellement dans index.html.

**Ancienne méthode (deprecated) :**
```html
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore.js"></script>
```

**Nouvelle méthode (FlutterFire) :**
Tout géré via `firebase_options.dart` et packages Dart.

### CORS et Firebase Storage

Si vous utilisez Firebase Storage pour des images :

**Configuration requise dans Firebase Console :**

```json
[
  {
    "origin": ["*"],
    "method": ["GET"],
    "maxAgeSeconds": 3600
  }
]
```

**Commande gsutil :**
```bash
gsutil cors set cors.json gs://flutter-recette-october-2025.firebasestorage.app
```

---

## Configuration Windows

### Options Windows

```dart
static const FirebaseOptions windows = FirebaseOptions(
  apiKey: 'AIzaSyBmYg5-3PoffTGqShhVKrTsylxnHz1-XNs',
  appId: '1:378029160591:web:406dd113a3e042d0db98fa',
  messagingSenderId: '378029160591',
  projectId: 'flutter-recette-october-2025',
  authDomain: 'flutter-recette-october-2025.firebaseapp.com',
  storageBucket: 'flutter-recette-october-2025.firebasestorage.app',
  measurementId: 'G-MSR6PKZHM2',
);
```

### Plugins générés

#### Fichier : windows/flutter/generated_plugin_registrant.cc

```cpp
#include "generated_plugin_registrant.h"

#include <firebase_core/firebase_core_plugin_c_api.h>

void RegisterPlugins(flutter::PluginRegistry* registry) {
  FirebaseCorePluginCApiRegisterWithRegistrar(
      registry->GetRegistrarForPlugin("FirebaseCorePluginCApi"));
}
```

#### Fichier : windows/flutter/generated_plugins.cmake

```cmake
list(APPEND FLUTTER_PLUGIN_LIST
  firebase_core
)

list(APPEND FLUTTER_FFI_PLUGIN_LIST
)

set(PLUGIN_BUNDLED_LIBRARIES)

foreach(plugin ${FLUTTER_PLUGIN_LIST})
  add_subdirectory(flutter/ephemeral/.plugin_symlinks/${plugin}/windows plugins/${plugin})
  target_link_libraries(${BINARY_NAME} PRIVATE ${plugin}_plugin)
  list(APPEND PLUGIN_BUNDLED_LIBRARIES $<TARGET_FILE:${plugin}_plugin>)
  list(APPEND PLUGIN_BUNDLED_LIBRARIES ${${plugin}_bundled_libraries})
endforeach(plugin)
```

---

## Fichiers de configuration Firebase CLI

### .firebaserc

#### Emplacement

Racine du projet : `.firebaserc`

#### Contenu

```json
{
  "projects": {
    "default": "flutter-recette-october-2025"
  }
}
```

#### Utilisation

Définit le projet par défaut pour les commandes Firebase CLI :
```bash
firebase deploy  # Utilise le projet "default"
```

#### Projets multiples

```json
{
  "projects": {
    "default": "flutter-recette-october-2025-1",
    "prod": "flutter-recette-prod",
    "staging": "flutter-recette-staging"
  }
}
```

**Sélection :**
```bash
firebase use default
firebase use prod
firebase use staging
```

### firebase.json

#### Emplacement

Racine du projet : `firebase.json`

#### Contenu

```json
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  }
}
```

#### Configuration complète (exemple)

```json
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "build/web",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  },
  "storage": {
    "rules": "storage.rules"
  }
}
```

#### Sections disponibles

| Section | Description | Fichier de config |
|---------|-------------|-------------------|
| firestore | Règles et index Firestore | firestore.rules |
| hosting | Firebase Hosting | build/web/ |
| storage | Cloud Storage | storage.rules |
| functions | Cloud Functions | functions/ |
| emulators | Emulateurs locaux | N/A |

### firestore.rules

#### Emplacement

Racine du projet : `firestore.rules`

#### Contenu actuel

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
```

#### Évolution des règles

**Version initiale (temporaire) :**
```javascript
allow read, write: if request.time < timestamp.date(2025, 11, 22);
```

**Version développement (actuelle) :**
```javascript
allow read, write: if true;
```

**Version production (recommandée) :**
```javascript
match /categories/{category} {
  allow read: if true;
  allow write: if request.auth != null && 
                 request.auth.token.admin == true;
}
```

#### Déploiement

```bash
firebase deploy --only firestore:rules
```

**Sortie :**
```
=== Deploying to 'flutter-recette-october-2025-1'...

i  deploying firestore
i  cloud.firestore: checking firestore.rules for compilation errors...
+  cloud.firestore: rules file firestore.rules compiled successfully
i  firestore: uploading rules firestore.rules...
+  firestore: released rules firestore.rules to cloud.firestore

+  Deploy complete!
```

### firestore.indexes.json

#### Emplacement

Racine du projet : `firestore.indexes.json`

#### Contenu initial

```json
{
  "indexes": [],
  "fieldOverrides": []
}
```

#### Exemple avec index composé

```json
{
  "indexes": [
    {
      "collectionGroup": "recipes",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "category",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}
```

**Utilité :**
- Optimisation des requêtes complexes
- Requis pour certaines queries (orderBy + where)
- Généré automatiquement par Firebase

#### Déploiement

```bash
firebase deploy --only firestore:indexes
```

---

## Migration entre projets

### Contexte de la migration

**Projet source :** flutter-recette-october-2025  
**Projet destination :** flutter-recette-october-2025-1  
**Raison :** Problèmes de permissions et configuration

### Fichiers à mettre à jour

#### 1. .firebaserc

**Modification :**
```json
{
  "projects": {
    "default": "flutter-recette-october-2025-1"
  }
}
```

#### 2. Scripts PowerShell

**Fichier : scripts/add_categories_gcloud.ps1**
```powershell
$projectId = "flutter-recette-october-2025-1"
```

**Fichier : scripts/remove_icons_from_categories.ps1**
```powershell
$projectId = "flutter-recette-october-2025-1"
```

#### 3. firebase_options.dart

**Option 1 : Régénération complète**
```bash
flutterfire configure
```

**Option 2 : Modification manuelle**

Remplacer tous les `projectId` :
```dart
projectId: 'flutter-recette-october-2025-1',
```

#### 4. google-services.json (Android)

**Télécharger depuis Firebase Console :**
1. Project Settings > General
2. Votre application Android
3. Cliquer sur "google-services.json"
4. Remplacer `android/app/google-services.json`

#### 5. GoogleService-Info.plist (iOS)

**Télécharger depuis Firebase Console :**
1. Project Settings > General
2. Votre application iOS
3. Cliquer sur "GoogleService-Info.plist"
4. Remplacer `ios/Runner/GoogleService-Info.plist`

### Procédure de migration complète

#### Étape 1 : Sauvegarde

```bash
# Créer une branche
git checkout -b backup-old-project

# Commit de l'état actuel
git add .
git commit -m "backup avant migration projet Firebase"
```

#### Étape 2 : Nouveau projet Firebase

**Firebase Console :**
1. Créer nouveau projet
2. Nom : flutter-recette-october-2025-1
3. Activer Google Analytics (optionnel)
4. Créer le projet (attendre 1-2 minutes)

#### Étape 3 : Configuration Firestore

```bash
# Via Firebase Console
1. Firestore Database > Créer une base de données
2. Mode Test
3. Région : europe-west3
4. Activer
```

**OU via gcloud (après configuration facturation) :**
```bash
gcloud firestore databases create --location=europe-west3 --project=flutter-recette-october-2025-1
```

#### Étape 4 : Enregistrement des applications

**Pour chaque plateforme :**

1. **Web :**
   - Project Settings > Add app > Web
   - Nickname : "Web App"
   - Firebase Hosting : Non (pour l'instant)
   - Copier la configuration

2. **Android :**
   - Project Settings > Add app > Android
   - Package name : com.example.projetrecette
   - Télécharger google-services.json

3. **iOS :**
   - Project Settings > Add app > iOS
   - Bundle ID : com.example.projetrecette
   - Télécharger GoogleService-Info.plist

#### Étape 5 : FlutterFire configure

```bash
# Installation FlutterFire CLI (si pas déjà fait)
dart pub global activate flutterfire_cli

# Configuration
flutterfire configure
```

**Processus interactif :**
```
? Select a Firebase project to configure your Flutter application with
  > flutter-recette-october-2025-1 (flutter-recette-october-2025-1)
  
? Which platforms should your configuration support?
  > android, ios, macos, web, windows
  
i Firebase android app com.example.projetrecette is already registered.
i Firebase ios app com.example.projetrecette is already registered.
i Firebase web app is already registered.
i Firebase macos app com.example.projetrecette is already registered.
i Firebase windows app is already registered.

i Generating firebase_options.dart...
✓ Generated lib/firebase_options.dart successfully.
```

#### Étape 6 : Mise à jour des scripts

**Scripts PowerShell :**
```powershell
# Éditer scripts/add_categories_gcloud.ps1
$projectId = "flutter-recette-october-2025-1"

# Éditer scripts/remove_icons_from_categories.ps1
$projectId = "flutter-recette-october-2025-1"
```

#### Étape 7 : Configuration gcloud

```bash
gcloud config set project flutter-recette-october-2025-1
```

#### Étape 8 : Déploiement des règles

```bash
firebase use flutter-recette-october-2025-1
firebase deploy --only firestore
```

#### Étape 9 : Test

```bash
flutter clean
flutter pub get
flutter run -d chrome
```

**Vérifications :**
- Application démarre
- Aucune erreur Firebase dans les logs
- Test Firebase dans Settings réussit

#### Étape 10 : Migration des données

**Si données existantes dans l'ancien projet :**

```bash
# Export depuis ancien projet
gcloud firestore export gs://bucket-name --project=flutter-recette-october-2025

# Import dans nouveau projet
gcloud firestore import gs://bucket-name --project=flutter-recette-october-2025-1
```

**OU** réinitialiser avec les scripts :
```powershell
.\scripts\add_categories_gcloud.ps1
```

#### Étape 11 : Commit et push

```bash
git add .
git commit -m "migration vers flutter-recette-october-2025-1"
git push origin main
```

---

## Sécurité des clés API

### API Keys publiques vs privées

#### API Keys dans firebase_options.dart

**Type :** Publiques

**Sécurité :**
- Ces clés PEUVENT être exposées
- Elles identifient votre app, pas l'utilisateur
- Protection via règles Firestore et Authentication

**Ne PAS traiter comme secrètes :**
- OK de commiter dans Git
- OK d'exposer dans le code
- OK dans le code source public

#### Protection réelle

**Via règles Firestore :**
```javascript
allow write: if request.auth != null;
```

**Via Authentication :**
- Utilisateurs doivent se connecter
- Tokens validés côté serveur

### Restrictions API Keys

**Configuration dans Google Cloud Console :**

1. API & Services > Credentials
2. Sélectionner l'API Key
3. Application restrictions :
   - HTTP referrers (web)
   - Bundle IDs (iOS)
   - Package names (Android)

**Exemple Web :**
```
HTTP referrers:
- https://flutter-recette-october-2025.web.app/*
- https://flutter-recette-october-2025.firebaseapp.com/*
- http://localhost:*
```

### Gestion des secrets

**Vraies clés secrètes (si utilisées) :**

1. **Service Account Keys**
   - Ne JAMAIS commiter
   - Stocker dans .gitignore
   - Utiliser variables d'environnement en production

2. **Cloud Functions config**
   ```bash
   firebase functions:config:set someservice.key="THE_KEY"
   ```

3. **GitHub Secrets** (pour CI/CD)
   - Settings > Secrets and variables
   - Ajouter les clés sensibles

---

## Commandes de vérification

### Vérifier la configuration actuelle

```bash
# Projet Firebase CLI
firebase projects:list
firebase use

# Projet gcloud
gcloud config get-value project

# FlutterFire
cat lib/firebase_options.dart | grep projectId

# Android
cat android/app/google-services.json | grep project_id
```

### Vérifier les services activés

```bash
# Liste des bases Firestore
gcloud firestore databases list --project=flutter-recette-october-2025-1

# Informations du projet
firebase projects:list
```

### Tester la connexion

```bash
# Depuis l'application
flutter run -d chrome
# Settings > Test Firebase > Vérifier

# Depuis un script
.\scripts\add_categories_gcloud.ps1
```

---

## Troubleshooting configuration

### Problème : Firebase not initialized

**Erreur :**
```
[core/no-app] No Firebase App '[DEFAULT]' has been created
```

**Solutions :**

1. Vérifier main.dart :
```dart
await Firebase.initializeApp(
  options: DefaultFirebaseOptions.currentPlatform,
);
```

2. Vérifier firebase_options.dart existe

3. Régénérer :
```bash
flutterfire configure
```

### Problème : Platform not configured

**Erreur :**
```
UnsupportedError: DefaultFirebaseOptions have not been configured for linux
```

**Solution :**

Ajouter la plateforme :
```bash
flutterfire configure
# Sélectionner linux dans les plateformes
```

### Problème : API Key mismatch

**Erreur :**
```
API key not valid. Please pass a valid API key.
```

**Solutions :**

1. Vérifier dans Firebase Console > Project Settings
2. Comparer avec firebase_options.dart
3. Régénérer la configuration
4. Vérifier les restrictions d'API key

### Problème : Package name mismatch (Android)

**Erreur :**
```
Default FirebaseApp failed to initialize
```

**Cause :**
Package name dans google-services.json != applicationId dans build.gradle

**Vérification :**
```bash
# google-services.json
cat android/app/google-services.json | grep package_name

# build.gradle
cat android/app/build.gradle.kts | grep applicationId
```

**Solution :**
Ils doivent être identiques : `com.example.projetrecette`

---

## Checklist de configuration

### Configuration initiale

- [ ] Projet Firebase créé
- [ ] Firestore activé
- [ ] Applications enregistrées (Web, Android, iOS)
- [ ] FlutterFire CLI installé
- [ ] flutterfire configure exécuté
- [ ] firebase_options.dart généré
- [ ] google-services.json téléchargé (Android)
- [ ] GoogleService-Info.plist téléchargé (iOS)

### Configuration fichiers

- [ ] .firebaserc créé avec bon project ID
- [ ] firebase.json créé
- [ ] firestore.rules créé
- [ ] firestore.indexes.json créé
- [ ] pubspec.yaml avec firebase_core et cloud_firestore
- [ ] lib/main.dart avec Firebase.initializeApp()

### Déploiement

- [ ] firebase deploy --only firestore réussi
- [ ] Règles visibles dans Firebase Console
- [ ] Test de lecture/écriture fonctionne

### Validation

- [ ] flutter run -d chrome sans erreur
- [ ] Settings > Test Firebase : TOUS LES TESTS RÉUSSIS
- [ ] Settings > Administration : Initialisation fonctionne
- [ ] Firebase Console : Catégories visibles

---

**Fin du document**

Document suivant : [10-HISTORIQUE_COMMITS_GIT.md](10-HISTORIQUE_COMMITS_GIT.md)

